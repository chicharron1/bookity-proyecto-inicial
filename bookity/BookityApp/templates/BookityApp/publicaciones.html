{% extends 'BookityApp/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<!-- Contenedor para ambos títulos en la misma línea -->
<div class="contenedor-titulos">
  <h1 class="titulo-seccion" style="margin-right: 0px;">Publicaciones</h1>
  <h1 class="titulo-seccion" style="margin-right: 0px;">Mapa de publicaciones</h1>
</div>

<div class="contenedor-principal">
  <!-- Columna de publicaciones -->
  <div class="contenedor-publicaciones">
    {% if publicaciones %}
      <div class="scroll-box">
        {% for publicacion in publicaciones %}
          <div class="publicacion">
            <h2>{{ publicacion.titulo }}</h2>
            <p><strong>Autor:</strong> {{ publicacion.user.username }}</p>
            <p>{{ publicacion.descripcion|truncatechars:30 }}</p>
            <p><em>Publicado el {{ publicacion.fecha_publicacion|date:"d/m/Y H:i" }}</em></p>
            <div>
              <a href="{% url 'detalle' publicacion.id %}">Ver más información</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>No hay publicaciones todavía.</p>
    {% endif %}
  </div>
  
  <!-- Columna del mapa -->
  <div class="contenedor-mapa">
    <div id="map"></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  {% if user.perfil.longitud_defecto and user.perfil.latitud_defecto %}
    var map = L.map('map').setView([{{ user.perfil.latitud_defecto }}, {{ user.perfil.longitud_defecto }}], 16);
  {% else %}
    var map = L.map('map').setView([0, 0], 16);
  {% endif %}

  L.tileLayer('https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=EdWFsXtwOisU8uwq86cZ', {
      maxZoom: 19,
      attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'}).addTo(map);
  
  {% if publicaciones %}
    {% for publicacion in publicaciones %}
      L.marker([{{ publicacion.latitud }}, {{ publicacion.longitud }}])
      .addTo(map)
      .bindPopup('<b>{{ publicacion.titulo }}</b><br>{{ publicacion.descripcion|truncatechars:65|escapejs }} <a href="{% url 'detalle' publicacion.id %}">Ver más información</a>');
    {% endfor %}
  {% endif %}
</script>
{% endblock %}